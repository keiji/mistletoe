# GitHub Pull Request 安全性テスト設計書

本ドキュメントは、`mstl-gh` の `pr create` コマンド実行中に、リポジトリの状態が変化した場合（競合状態）の安全性チェック機能を検証する手動テスト手順を定義します。

## 概要

`pr create` は、ステータス収集から Push 実行までの間にタイムラグがあります。この間に他のプロセス（またはユーザー）がリポジトリに変更を加えた場合、意図しない上書きや不整合を防ぐため、処理を中断する必要があります。

## テスト構成

*   **リポジトリ**: ローカルおよびリモートのダミーリポジトリを使用（GitHub への接続はモック化）。
*   **ツール**: `mstl-gh` および 偽装した `gh` コマンド（スクリプト内で生成）。

## テスト手順

本テストは、`manual_tests/manual_test_gh_pr_create_safety.py` スクリプトによって自動化されています。

1.  **環境構築**:
    *   テスト用ディレクトリ作成。
    *   ローカル Git リポジトリ（A）とリモート（Bare）の作成。
    *   初期コミットと Push。
    *   ローカルでコミットを追加（リモートより先行させる）。

2.  **`pr create` の開始**:
    *   `mstl-gh pr create` を実行し、ユーザー確認プロンプト（"Proceed with Push?"）で待機させる。

3.  **競合の注入**:
    *   プロンプト待機中に、バックグラウンドでローカルリポジトリに新しいコミットを追加する。
    *   これにより、`mstl-gh` が最初に収集したリビジョンと現在のリビジョンに不整合が生じる。

4.  **処理の再開**:
    *   `pr create` プロセスに "yes" を入力して続行させる。

5.  **検証**:
    *   ツールがエラーメッセージ（"has changed since status collection" 等）を出力して異常終了することを確認する。
    *   Push が実行されていないことを確認する。

## 期待される結果

*   **SUCCESS**: 安全性チェックが機能し、変更検知により処理が中断された場合。
*   **FAILURE**: エラーにならずに処理が完了してしまった場合。
