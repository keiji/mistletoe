# mstl-gh 手動テスト設計書

本書は、`mstl-gh` コマンドラインツールの機能（特に GitHub 連携機能）を検証するための Python スクリプトの設計概要を記述します。

## 1. 概要 (Overview)

本テストスクリプトは、GitHub CLI (`gh`) を使用して実際にプライベートリポジトリを作成し、`mstl-gh` の各サブコマンドを実行して動作を検証します。
既存のリポジトリへの影響を防ぐため、UUID を用いた一意なリポジトリ名を使用し、厳格な安全確認を行います。

## 2. 前提条件 (Prerequisites)

*   Python 3.x
*   Go (`mstl-gh` のビルド用)
*   GitHub CLI (`gh`) がインストールされ、認証済みであること (`gh auth status` で確認)。
    *   `repo` スコープの権限が必要です。

## 3. 安全機構 (Safety Mechanisms)

誤操作を防ぐため、以下の安全チェックを実装します。

1.  **既存リポジトリの確認:** `gh repo list` を実行し、リポジトリが1つでも存在する場合、警告を表示します。
2.  **ユーザー同意:** 以下の内容を含む警告を表示し、ユーザーに "I AGREE" の入力を求めます。
    *   既存のリポジトリが存在すること。
    *   （万が一の）既存リポジトリ破壊のリスク。
    *   今回作成する一時リポジトリのリスト。
3.  **一意な名前:** リポジトリ名には UUID を含めます (例: `mistletoe-test-[UUID]-A`)。
4.  **クリーンアップ:** テスト終了時（成功・失敗問わず）に作成したリポジトリを削除します。

## 4. テストシナリオ (Test Scenarios)

### 4.1. 準備 (Setup)
1.  UUID を生成します。
2.  2つのプライベートリポジトリ (`repo-A`, `repo-B`) を `gh repo create` で作成します。
3.  これらを指す設定ファイル `mistletoe.json` を生成します。
4.  `mstl-gh` バイナリをビルドします。

### 4.2. 初期化 (`init`)
*   **コマンド:** `mstl-gh init -f mistletoe.json`
*   **検証:** 指定したディレクトリにリポジトリがクローンされていること。

### 4.3. ステータスとスイッチ (`status`, `switch`)
*   **コマンド:** `mstl-gh status`
*   **検証:** クリーンな状態であること。
*   **コマンド:** `mstl-gh switch -c feature/test-gh`
*   **検証:** 両方のリポジトリが `feature/test-gh` ブランチに切り替わっていること。

### 4.4. 変更のプッシュ (`push`)
*   **操作:** 各リポジトリで空のコミットを作成します。
*   **コマンド:** `mstl-gh push` (自動化のため `yes` をパイプするかフラグを使用)。
*   **検証:** リモートにプッシュされていること。

### 4.5. PR作成 (`pr create`)
*   **コマンド:** `mstl-gh pr create -t "Test PR" -b "Body content"`
*   **検証:** GitHub 上に PR が作成されていること (`gh pr list` で確認)。

### 4.6. PRステータス (`pr status`)
*   **コマンド:** `mstl-gh pr status`
*   **検証:** 作成した PR が表示されること。

### 4.7. PR更新 (`pr update`)
*   **操作:** ローカルでさらにコミットしてプッシュします。
*   **コマンド:** `mstl-gh pr update`
*   **検証:** PR の本文（Mistletoe ブロック）が更新されていること。

### 4.8. スナップショットとチェックアウト (`snapshot`, `pr checkout`)
*   **コマンド:** `mstl-gh snapshot`
*   **検証:** スナップショット JSON が生成されること。
*   **操作:** テスト用ディレクトリを一度削除（または別ディレクトリを使用）。
*   **コマンド:** `mstl-gh pr checkout -u [PR URL]`
*   **検証:** PR に埋め込まれたスナップショット情報から環境が復元されること。

## 5. 実装の詳細 (Internal Logic)

*   Python の `subprocess` モジュールを使用してコマンドを実行します。
*   `try...finally` ブロックを使用して、エラー発生時でも確実にリポジトリ削除（`gh repo delete`）を行います。
*   標準入力が必要なコマンド（`push` の確認など）には `input` 引数を使用します。
